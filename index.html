<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>GeoAR.js demo</title>
    <script src='https://aframe.io/releases/0.9.2/aframe.min.js'></script>
    <script src="https://raw.githack.com/jeromeetienne/AR.js/master/aframe/build/aframe-ar.min.js"></script>
    <script src="https://raw.githack.com/donmccurdy/aframe-extras/master/dist/aframe-extras.loaders.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex-location-only.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script> <!-- CSV Parser -->
</head>
<body style='margin: 0; overflow: hidden;'>
    <a-scene
        vr-mode-ui="enabled: false"
        embedded
        arjs='sourceType: webcam; sourceWidth:1280; sourceHeight:960; displayWidth: 1280; displayHeight: 960; debugUIEnabled: true;'>
        
        <!-- User's Location Text -->
        <a-entity id="user-location-text" position="0 2 -4"
                  text="value: Getting location...; color: white; width: 6; align: center;">
        </a-entity>

        <!-- Camera -->
        <a-camera gps-camera rotation-reader></a-camera>
    </a-scene>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const scene = document.querySelector("a-scene");
            const userText = document.getElementById("user-location-text");

            // Fetch and display user's GPS location
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(position => {
                    let userLat = position.coords.latitude;
                    let userLon = position.coords.longitude;

                    // Update the text with user's coordinates
                    userText.setAttribute("text", `value: Your Location: ${userLat}, ${userLon};`);

                    // Create a blue marker for user's location
                    let userMarker = document.createElement("a-circle");
                    userMarker.setAttribute("gps-entity-place", `longitude: ${userLon}; latitude: ${userLat}`);
                    userMarker.setAttribute("radius", "0.7");
                    userMarker.setAttribute("color", "blue");
                    userMarker.setAttribute("position", "0 1 -3");
                    scene.appendChild(userMarker);
                }, error => {
                    userText.setAttribute("text", "value: Unable to get location.");
                });
            } else {
                userText.setAttribute("text", "value: Geolocation not supported.");
            }

            // Load CSV and add plant markers
            fetch('ABG_Database_101124wSID_cleaned_112824_wHornbake.csv')
                .then(response => response.text())
                .then(csvData => {
                    Papa.parse(csvData, {
                        header: true,
                        skipEmptyLines: true,
                        complete: function(results) {
                            results.data.forEach(row => {
                                let { s_id, cname1, cname2, cname3, genus, species, cultivar, longitude, latitude, Plants_On_Hornbake } = row;

                                longitude = longitude?.trim();
                                latitude = latitude?.trim();

                                if (!longitude || !latitude) return;

                                let combinedName = [cname1, cname2, cname3, genus, species, cultivar]
                                    .filter(val => val && val.trim() !== "")
                                    .join(" ");

                                let circle = document.createElement("a-circle");
                                circle.setAttribute("gps-entity-place", `longitude: ${longitude}; latitude: ${latitude}`);
                                circle.setAttribute("radius", "0.5");
                                circle.setAttribute("color", "red");
                                circle.setAttribute("position", "0 1 -3");

                                let textEntity = document.createElement("a-entity");
                                textEntity.setAttribute("gps-entity-place", `longitude: ${longitude}; latitude: ${latitude}`);
                                textEntity.setAttribute("text", `value: ${combinedName}; color: white; width: 6; align: center;`);
                                textEntity.setAttribute("position", "0 1.5 -3");
                                textEntity.setAttribute("visible", "false");

                                circle.addEventListener("click", () => {
                                    let isVisible = textEntity.getAttribute("visible");
                                    textEntity.setAttribute("visible", !isVisible);
                                });

                                scene.appendChild(circle);
                                scene.appendChild(textEntity);
                            });
                        }
                    });
                });
        });
    </script>
</body>
</html>
