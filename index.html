<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>GeoAR.js demo</title>
    <script src='https://aframe.io/releases/0.9.2/aframe.min.js'></script>
    <script src="https://raw.githack.com/jeromeetienne/AR.js/master/aframe/build/aframe-ar.min.js"></script>
    <script src="https://raw.githack.com/donmccurdy/aframe-extras/master/dist/aframe-extras.loaders.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script> <!-- CSV Parser -->
</head>
<body style='margin: 0; overflow: hidden;'>
    <a-scene
        vr-mode-ui="enabled: false"
        embedded
        arjs='sourceType: webcam; sourceWidth:1280; sourceHeight:960; displayWidth: 1280; displayHeight: 960; debugUIEnabled: true;'>
        
        <!-- User's Location Text (Smaller and at Bottom) -->
        <a-entity id="user-location-text" position="0 -2 -3"
                  text="value: Getting location...; color: white; width: 2; align: center;">
        </a-entity>

        <!-- Camera -->
        <a-camera id='camera1' look-controls-enabled='false' arjs-look-controls='smoothingFactor: 0.1' gps-new-camera> 
        </a-camera>
    </a-scene>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const scene = document.querySelector("a-scene");
            const userText = document.getElementById("user-location-text");

            // Fetch and display user's GPS location
            if ("geolocation" in navigator) {
                navigator.geolocation.watchPosition(position => {
                    let userLat = position.coords.latitude;
                    let userLon = position.coords.longitude;

                    // Update text with user's coordinates
                    userText.setAttribute("text", `value: Your Location: ${userLat.toFixed(6)}, ${userLon.toFixed(6)};`);

                    // Create a blue marker for user's location (if not already present)
                    if (!document.getElementById("user-marker")) {
                        let userMarker = document.createElement("a-circle");
                        userMarker.setAttribute("id", "user-marker");
                        userMarker.setAttribute("gps-new-entity-place", `latitude: ${userLat}; longitude: ${userLon}`);
                        userMarker.setAttribute("radius", "0.7");
                        userMarker.setAttribute("color", "blue");
                        scene.appendChild(userMarker);
                    }
                }, error => {
                    userText.setAttribute("text", "value: Unable to get location.");
                }, { enableHighAccuracy: true });
            } else {
                userText.setAttribute("text", "value: Geolocation not supported.");
            }

            // Load CSV and add plant markers
            fetch('ABG_Database_101124wSID_cleaned_112824_wHornbake.csv')
                .then(response => response.text())
                .then(csvData => {
                    Papa.parse(csvData, {
                        header: true,
                        skipEmptyLines: true,
                        complete: function(results) {
                            results.data.forEach(row => {
                                let { cname1, cname2, cname3, genus, species, cultivar, longitude, latitude } = row;

                                longitude = longitude?.trim();
                                latitude = latitude?.trim();

                                if (!longitude || !latitude) return;

                                let combinedName = [cname1, cname2, cname3, genus, species, cultivar]
                                    .filter(val => val && val.trim() !== "")
                                    .join(" ");

                                let circle = document.createElement("a-circle");
                                circle.setAttribute("gps-new-entity-place", `latitude: ${latitude}; longitude: ${longitude}`);
                                circle.setAttribute("radius", "0.5");
                                circle.setAttribute("color", "red");

                                let textEntity = document.createElement("a-entity");
                                textEntity.setAttribute("gps-new-entity-place", `latitude: ${latitude}; longitude: ${longitude}`);
                                textEntity.setAttribute("text", `value: ${combinedName}; color: white; width: 4; align: center;`);
                                textEntity.setAttribute("visible", "false");

                                circle.addEventListener("click", () => {
                                    let isVisible = textEntity.getAttribute("visible");
                                    textEntity.setAttribute("visible", !isVisible);
                                });

                                scene.appendChild(circle);
                                scene.appendChild(textEntity);
                            });
                        }
                    });
                });
        });
    </script>
</body>
</html>
